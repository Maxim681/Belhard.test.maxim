# Импортируем необходимые модули
import csv  # для работы с CSV файлами
from datetime import datetime, timedelta  # для работы с датами


def main():
    # Чтение исходного файла с продажами
    # Используем менеджер контекста (with) для автоматического закрытия файла
    with open('sales.csv', 'r', encoding='utf-8') as f:
        # Читаем данные в список словарей, где каждый словарь - строка таблицы
        data = list(csv.DictReader(f))

    # Вычисляем дату, которая была 30 дней назад от текущей даты
    # Это нужно для фильтрации продаж за последний месяц
    month_ago = datetime.now() - timedelta(days=30)

    # Фильтруем продажи: оставляем только те, что были за последние 30 дней
    recent_sales = []  # список для хранения отфильтрованных данных
    for row in data:
        try:
            # Преобразуем строку с датой в объект datetime для сравнения
            # Формат даты: год-месяц-день (например, 2024-01-15)
            sale_date = datetime.strptime(row['date'], '%Y-%m-%d')

            # Проверяем, была ли продажа в последние 30 дней
            if sale_date >= month_ago:
                recent_sales.append(row)  # добавляем подходящую запись
        except:
            # Если возникла ошибка при преобразовании даты, пропускаем эту запись
            continue

    # Подсчитываем общую выручку и добавляем колонку с общей стоимостью
    total_money = 0  # переменная для накопления общей суммы
    good_sales = []  # список для валидных продаж (с ненулевым количеством)

    # Обрабатываем каждую отфильтрованную продажу
    for item in recent_sales:
        try:
            # Преобразуем цену в число с плавающей точкой
            cost = float(item['price'])
            # Преобразуем количество в целое число
            count = int(item['quantity'])

            # Проверяем, что количество больше нуля (исключаем нулевые продажи)
            if count > 0:
                # Вычисляем общую стоимость для этого товара
                item_total = cost * count
                # Добавляем к общей выручке
                total_money += item_total
                # Добавляем новую колонку 'total' в данные о продаже
                item['total'] = str(item_total)
                # Сохраняем обработанную запись
                good_sales.append(item)
        except:
            # Если возникла ошибка при преобразовании чисел, пропускаем запись
            pass

    # Сортируем продажи по убыванию выручки (от большей к меньшей)
    # Используем lambda-функцию для указания поля сортировки
    good_sales.sort(key=lambda x: float(x['total']), reverse=True)

    # Записываем обработанные данные в новый CSV файл
    with open('recent_sales.csv', 'w', newline='', encoding='utf-8') as f:
        # Определяем названия колонок для нового файла
        columns = ['product', 'price', 'quantity', 'date', 'total']
        # Создаем объект для записи CSV
        writer = csv.DictWriter(f, fieldnames=columns)
        # Записываем заголовок (названия колонок)
        writer.writeheader()
        # Записываем все данные
        writer.writerows(good_sales)

    # Выводим результаты работы программы
    print(f"Всего заработано: {total_money:.2f}")
    print(f"Записей сохранено: {len(good_sales)}")


# Стандартная проверка для запуска функции main
# при непосредственном выполнении этого файла
if __name__ == "__main__":
    main()